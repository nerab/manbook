#!/usr/bin/env ruby

$:.unshift File.join(File.dirname(__FILE__), *%w[.. lib])

require 'rubygems'

help = <<HELP
The manbook command can be used to produce an eBook from one or more man pages.

Author: Nicolas E. Rabenau nerab@gmx.at
Homepage: http://rubydoc.info/gems/manbook/file/README.md

Basic Usage:

    manbook <MANPAGE>
    manbook <MANPAGE1> [<MANPAGE2> ...]
    manbook <MANPAGE> --output <DIRECTORY>
    manbook <MANPAGE1> [<MANPAGE2> ...] --output <DIRECTORY>
    manbook --all --output <DIRECTORY>

Options:
HELP

def usage
  "Run '#{File.basename(__FILE__)} --help' for further help."
end

require 'optparse'
require 'open4'
require 'manbook'

output_dir = '.'

opts = OptionParser.new do |opts|
  opts.banner = help

  opts.on("--verbose", "Verbose mode - displays additional diagnostic information") do |file|
    ManBook.logger = Logger.new(STDERR)
    ManBook.logger.formatter = ManBook::LogFormatter.new
    ManBook.logger.level = Logger::INFO
  end

  opts.on("--trace", "Trace (debug) mode - displays debug information and stack traces") do |file|
    ManBook.logger = Logger.new(STDERR)
    ManBook.logger.formatter = ManBook::LogFormatter.new
    ManBook.logger.level = Logger::DEBUG
  end

  opts.on("--version", "Display current version") do
    puts "#{File.basename(__FILE__)} " + ManBook::VERSION
    exit 0
  end

  opts.on("--all", "Create a book with all man pages") do |dir|
    ManBook.logger.info "Creating a book with all man pages"
    raise "Not yet implemented"
  end

  opts.on("--output DIR", "Use DIR as output directory") do |dir|
    ManBook.logger.info "Using '#{dir}' as output directory"
    output_dir = dir
    Dir.mkdir(output_dir) unless File.exist?(output_dir)
  end
end

def html_name(man_page_file)
  "#{File.basename(man_page_file)}.html"
end

def execute(cmd)
  out, err = nil

  status = Open4::popen4(cmd){|pid, stdin, stdout, stderr|
    out = stdout.read
    err = stderr.read
  }

  raise ManBook::CommandFailedError.new(cmd, err.chomp) if 0 != $?

  out
end

def convert_to_html(man_page, html_file_name)
  # locate the man file
  begin
    man_page_file = execute("man -w #{man_page}").chomp!
  rescue ManBook::CommandFailedError => e
    raise ManBook::ManPageNotFoundError.new(e.msg)
  end

  ManBook.logger.debug("Located man page at #{man_page_file}")
  
  # pipe through gunzip if gzipped
  if man_page_file =~ /\.gz$/
    cmd = "gunzip -c #{man_page_file} | groff -mandoc -T html > #{html_file_name}"
  else
    cmd = puts "groff -mandoc #{man_page_file} -T html > #{html_file_name}"
  end
  
  ManBook.logger.debug("Executing #{cmd}")  
  execute(cmd)
  ManBook.logger.info "Successfully written '#{html_file_name}'"
end

begin
  opts.parse!
  
  ARGV.each{|man_page|
    html_file = File.join(output_dir, html_name(man_page))
    ManBook.logger.debug("Output page is #{html_file}")
    
    begin
      convert_to_html(man_page, html_file)
    rescue ManBook::ManPageNotFoundError => e
      ManBook.logger.error e.message
      ManBook.logger.debug "Backtrace:\n#{e.backtrace.join("\n")}"
    end
  }
rescue
  ManBook.logger.error $!.message
  ManBook.logger.debug "Backtrace:\n#{$!.backtrace.join("\n")}"
  ManBook.logger.info usage
  exit(1)
end
